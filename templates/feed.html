{% extends "base.html" %}
{% load static %}

{% block content %}
<body>
  <div class="gtco-loader"></div>
  <div id="page">
    <!-- Existing nav code -->
    {% include "nav.html" %}

    <header id="gtco-header" class="gtco-cover" role="banner" style="background-image: url({% static 'images/img_1.jpg' %})"
      data-stellar-background-ratio="0.5">
      <div class="overlay"></div>
      <div class="container">
        <div class="row">
          <div class="col-md-7 text-left">
            <div class="display-t">
              <div class="display-tc animate-box" data-animate-effect="fadeInUp">
                <span class="date-post">Feed</span>
                <h1 class="mb30"><a href="#">Welcome {{request.user}}</a></h1>
                {% if request.user.is_authenticated %}
                <p><a href="{% url 'post_create' %}" class="text-link">Create a Post</a></p>
                {% else %}
                <p><a href="{% url 'register' %}" class="text-link">Register</a> or <a href="{% url 'login' %}" class="text-link">Login</a> to post</p>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </header>

    <div id="gtco-main">
      <div class="container">
        {% if request.user.is_authenticated and project_id %}
        <!-- Analytics Section -->
        <div class="row row-pb-md">
          <div class="col-md-12">
            <div class="analytics-box animate-box" data-animate-effect="fadeIn">
              <h3>Your Post Interactions</h3>
              <div id="interactionsChart" style="height: 300px;"></div>
              <div id="chartError" class="alert alert-danger" style="display: none;"></div>
            </div>
          </div>
        </div>
        {% endif %}

        <!-- Existing Posts Section -->
        <div class="row row-pb-md">
          <div class="col-md-12">
            <ul id="gtco-post-list">
              {% if posts %}
              {% for p in posts %}
              <li class="one-third entry animate-box" data-animate-effect="fadeIn">
                <a href="{% url 'detail' p.id %}">
                  <div class="entry-img" style="background-image: url('{{p.image.url}}')"></div>
                  <div class="entry-desc">
                    <h3>{{p.title}}</h3>
                    <p>{{p.description}}.</p>
                  </div>
                </a>
                <a href="{% url 'detail' p.id %}" class="post-meta">{{p.user}} <span class="date-posted">{{p.created_at}}</span></a>
              </li>
              {% endfor %}
              {% else %}
              <li class="col-md-12">
                <div class="alert alert-info">No posts found.</div>
              </li>
              {% endif %}
            </ul>
          </div>
        </div>

        <!-- Pagination -->
        {% if posts.has_other_pages %}
        <div class="row">
          <div class="col-md-12 text-center">
            <nav aria-label="Page navigation">
              <ul class="pagination">
                {% if posts.has_previous %}
                <li>
                  <a href="?page={{ posts.previous_page_number }}" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                  </a>
                </li>
                {% endif %}
                
                {% for i in posts.paginator.page_range %}
                <li {% if posts.number == i %}class="active"{% endif %}>
                  <a href="?page={{ i }}">{{ i }}</a>
                </li>
                {% endfor %}
                
                {% if posts.has_next %}
                <li>
                  <a href="?page={{ posts.next_page_number }}" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                  </a>
                </li>
                {% endif %}
              </ul>
            </nav>
          </div>
        </div>
        {% endif %}
      </div>
    </div>

    <footer id="gtco-footer" role="contentinfo">
      {% include "footer.html" %}
    </footer>
  </div>

  {% block extra_js %}
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      {% if request.user.is_authenticated and project_id %}
        let chart = null;
        const projectId = '{{ project_id }}';
        const chartErrorDiv = document.getElementById('chartError');
        
        function showError(message) {
          if (chartErrorDiv) {
            chartErrorDiv.textContent = message;
            chartErrorDiv.style.display = 'block';
          }
        }
        
        function hideError() {
          if (chartErrorDiv) {
            chartErrorDiv.style.display = 'none';
          }
        }
        
        // Initialize WebSocket connection
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${wsProtocol}//${window.location.host}/ws/project/${projectId}/`;
        let ws = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 3;
        
        function connectWebSocket() {
          if (reconnectAttempts >= maxReconnectAttempts) {
            showError('Unable to connect to analytics service. Please refresh the page to try again.');
            return;
          }
          
          ws = new WebSocket(wsUrl);

          ws.onopen = function() {
            console.log('WebSocket connected');
            hideError();
            reconnectAttempts = 0;
            // Request initial analytics data
            ws.send(JSON.stringify({
              type: 'get_analytics'
            }));
          };

          ws.onmessage = function(e) {
            try {
              const data = JSON.parse(e.data);
              
              if (data.type === 'analytics_update') {
                hideError();
                updateChart(data.labels, data.data);
              } else if (data.type === 'error') {
                showError('Error updating analytics: ' + data.message);
              }
            } catch (error) {
              console.error('Error processing message:', error);
              showError('Error processing analytics data');
            }
          };

          ws.onerror = function(e) {
            console.error('WebSocket error:', e);
            showError('Error connecting to analytics service');
          };

          ws.onclose = function() {
            console.log('WebSocket disconnected');
            reconnectAttempts++;
            
            // Attempt to reconnect after a delay
            setTimeout(function() {
              if (reconnectAttempts < maxReconnectAttempts) {
                console.log(`Reconnecting... Attempt ${reconnectAttempts + 1}`);
                connectWebSocket();
              }
            }, 3000);
          };
        }

        function updateChart(labels, data) {
          const ctx = document.getElementById('interactionsChart').getContext('2d');
          
          if (chart) {
            chart.destroy();
          }
          
          chart = new Chart(ctx, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [{
                label: 'Comments on Your Posts',
                data: data,
                borderColor: '#2D3001',
                backgroundColor: 'rgba(45, 48, 1, 0.1)',
                tension: 0.4,
                fill: true
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: 'top',
                },
                title: {
                  display: true,
                  text: 'Post Interactions (Last 10 Days)'
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    stepSize: 1
                  }
                }
              }
            }
          });
        }
        
        // Start WebSocket connection
        connectWebSocket();
      {% endif %}
    });
  </script>
  {% endblock %}
</body>
{% endblock %} 